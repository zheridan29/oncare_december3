{% extends 'base.html' %}
{% load static %}

{% block title %}Payment Details - Order #{{ order.order_number }} - OnCare{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-money-check-alt me-2"></i>Payment Details - Order #{{ order.order_number }}
            </h1>
            <a href="{% url 'orders:pharmacist_order_detail' order.pk %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>Back to Order
            </a>
        </div>
    </div>
</div>

<div class="row">
    <!-- Order Summary -->
    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>Order Summary
                </h5>
            </div>
            <div class="card-body">
                <p><strong>Order Number:</strong> {{ order.order_number }}</p>
                <p><strong>Customer:</strong> {{ order.customer_name }}</p>
                <p><strong>Order Status:</strong> 
                    <span class="badge bg-{% if order.status == 'pending' %}warning{% elif order.status == 'processing' %}info{% elif order.status == 'ready_for_pickup' %}success{% elif order.status == 'delivered' %}dark{% elif order.status == 'cancelled' %}danger{% else %}secondary{% endif %}">
                        {{ order.get_status_display }}
                    </span>
                </p>
                <p><strong>Payment Status:</strong> 
                    <span class="badge bg-{% if order.payment_status == 'paid' %}success{% elif order.payment_status == 'pending' %}warning{% elif order.payment_status == 'failed' %}danger{% else %}secondary{% endif %}">
                        {{ order.get_payment_status_display }}
                    </span>
                </p>
                <hr>
                <div class="d-flex justify-content-between mb-2">
                    <span>Subtotal:</span>
                    <span>₱{{ order.subtotal|floatformat:2 }}</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Tax:</span>
                    <span>₱{{ order.tax_amount|floatformat:2 }}</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Shipping:</span>
                    <span>₱{{ order.shipping_cost|floatformat:2 }}</span>
                </div>
                {% if order.discount_amount > 0 %}
                <div class="d-flex justify-content-between mb-2 text-success">
                    <span>Discount:</span>
                    <span>-₱{{ order.discount_amount|floatformat:2 }}</span>
                </div>
                {% endif %}
                <hr>
                <div class="d-flex justify-content-between fw-bold fs-5">
                    <span>Total:</span>
                    <span>₱{{ order.total_amount|floatformat:2 }}</span>
                </div>
                {% if order.sales_rep %}
                <hr>
                <p class="mb-0"><strong>Sales Rep:</strong><br>
                    {{ order.sales_rep.get_full_name|default:order.sales_rep.username }}
                </p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Payment Information -->
    <div class="col-md-8">
        <!-- Transaction Details -->
        <div class="card mb-4" id="transaction-details-section">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-receipt me-2"></i>Transaction Details
                    {% if transactions %}({{ transactions|length }}){% else %}(0){% endif %}
                </h5>
            </div>
            <div class="card-body">
                {% if transactions %}
                    {% for transaction in transactions %}
                    <div class="transaction-details mb-4 {% if not forloop.last %}border-bottom pb-4{% endif %}">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <p class="mb-2"><strong>Transaction ID:</strong> 
                                    <span class="font-monospace">{{ transaction.transaction_id }}</span>
                                </p>
                                <p class="mb-2"><strong>Payment Method:</strong> {{ transaction.payment_method.name }}</p>
                                {% if transaction.payment_gateway %}
                                <p class="mb-2"><strong>Payment Gateway:</strong> 
                                    <span class="badge bg-info">{{ transaction.payment_gateway.display_name }}</span>
                                </p>
                                {% endif %}
                                {% if transaction.gateway_transaction_id %}
                                <p class="mb-2"><strong>Gateway Transaction ID:</strong> 
                                    <span class="font-monospace small text-break">{{ transaction.gateway_transaction_id }}</span>
                                </p>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <p class="mb-2"><strong>Amount:</strong> <span class="fs-5 fw-bold">₱{{ transaction.amount|floatformat:2 }}</span></p>
                                {% if transaction.processing_fee > 0 %}
                                <p class="mb-2"><strong>Processing Fee:</strong> ₱{{ transaction.processing_fee|floatformat:2 }}</p>
                                <p class="mb-2"><strong>Net Amount:</strong> <span class="fw-bold">₱{{ transaction.net_amount|floatformat:2 }}</span></p>
                                {% endif %}
                                <p class="mb-2"><strong>Status:</strong> 
                                    <span class="badge bg-{% if transaction.status == 'completed' %}success{% elif transaction.status == 'pending' %}warning{% elif transaction.status == 'failed' %}danger{% else %}secondary{% endif %} fs-6">
                                        {{ transaction.get_status_display }}
                                    </span>
                                </p>
                                <p class="mb-2"><strong>Created:</strong> {{ transaction.created_at|date:"M d, Y H:i" }}</p>
                                {% if transaction.completed_at %}
                                <p class="mb-2"><strong>Completed:</strong> {{ transaction.completed_at|date:"M d, Y H:i" }}</p>
                                {% endif %}
                            </div>
                        </div>
                        {% if transaction.notes %}
                        <div class="alert alert-info no-auto-hide">
                            <strong><i class="fas fa-sticky-note me-1"></i>Notes:</strong>
                            <p class="mb-0 mt-2">{{ transaction.notes }}</p>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="alert alert-warning mb-0 no-auto-hide">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>No transaction records found.</strong>
                        <br><small>Transaction details will appear here once a payment is processed.</small>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Manual Payment Submission Details - Always visible -->
        <div class="card mb-4" id="manual-payment-section">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-university me-2"></i>Manual Payment Submission Details
                </h5>
            </div>
            <div class="card-body">
                {% if has_manual_payment_submission %}
                    <div class="alert alert-info no-auto-hide">
                        <h6><strong>Payment Information Submitted:</strong></h6>
                        <pre style="white-space: pre-wrap; font-family: inherit; background: transparent; border: none; padding: 0; margin: 0;">{{ order.internal_notes }}</pre>
                    </div>
                {% else %}
                    <div class="alert alert-info no-auto-hide">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>No manual payment submission found.</strong>
                        <br><small>Manual payment submission details will appear here once submitted by the sales representative.</small>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Payment Proof Files -->
        <div class="card mb-4" id="payment-proof-files-section">
            <div class="card-header bg-warning text-dark">
                <h5 class="card-title mb-0">
                    <i class="fas fa-file-upload me-2"></i>Payment Proof Files 
                    {% if payment_proof_files %}({{ payment_proof_files|length }}){% else %}(0){% endif %}
                </h5>
            </div>
            <div class="card-body">
                {% if payment_proof_files %}
                    {% for proof_file in payment_proof_files %}
                    <div class="payment-proof-file mb-4 {% if not forloop.last %}border-bottom pb-4{% endif %}">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h6 class="mb-1">
                                    <i class="fas fa-file me-2"></i>{{ proof_file.original_filename }}
                                </h6>
                                <small class="text-muted">
                                    Uploaded by: <strong>{{ proof_file.uploaded_by.get_full_name|default:proof_file.uploaded_by.username }}</strong>
                                    on {{ proof_file.uploaded_at|date:"M d, Y H:i" }}
                                    • Size: {{ proof_file.file_size_mb }} MB
                                </small>
                            </div>
                            <div>
                                <a href="{{ proof_file.file.url }}" target="_blank" class="btn btn-sm btn-primary">
                                    <i class="fas fa-eye me-1"></i>View
                                </a>
                                <a href="{{ proof_file.file.url }}" download class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-download me-1"></i>Download
                                </a>
                            </div>
                        </div>
                        
                        <!-- Display image preview or PDF indicator -->
                        {% if proof_file.mime_type == 'application/pdf' or proof_file.original_filename|lower|slice:"-4:" == '.pdf' %}
                            <div class="text-center p-4 bg-light rounded">
                                <i class="fas fa-file-pdf fa-4x text-danger mb-3"></i>
                                <p class="mb-1"><strong>PDF Document</strong></p>
                                <small class="text-muted">Click "View" to open in new tab</small>
                            </div>
                        {% elif 'image' in proof_file.mime_type %}
                            <div class="text-center">
                                <img src="{{ proof_file.file.url }}" alt="Payment Proof" class="img-fluid border rounded shadow-sm" style="max-height: 500px; cursor: pointer;" data-bs-toggle="modal" data-bs-target="#paymentProofModal{{ proof_file.id }}">
                                <p class="text-muted small mt-2 mb-0"><i class="fas fa-info-circle me-1"></i>Click image to view full size</p>
                            </div>
                            
                            <!-- Modal for full-size image view -->
                            <div class="modal fade" id="paymentProofModal{{ proof_file.id }}" tabindex="-1" aria-labelledby="paymentProofModalLabel{{ proof_file.id }}" aria-hidden="true">
                                <div class="modal-dialog modal-xl modal-dialog-centered">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="paymentProofModalLabel{{ proof_file.id }}">
                                                <i class="fas fa-file-image me-2"></i>Payment Proof - {{ proof_file.original_filename }}
                                            </h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body text-center bg-light">
                                            <img src="{{ proof_file.file.url }}" alt="Payment Proof" class="img-fluid">
                                        </div>
                                        <div class="modal-footer">
                                            <a href="{{ proof_file.file.url }}" download class="btn btn-primary">
                                                <i class="fas fa-download me-1"></i>Download
                                            </a>
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="alert alert-info mb-0 no-auto-hide">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>No payment proof files uploaded yet.</strong>
                        {% if has_manual_payment_submission %}
                        <br><small>The sales representative has submitted manual payment information, but no proof files were attached.</small>
                        {% else %}
                        <br><small>Payment proof files will appear here once uploaded by the sales representative.</small>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Payment Verification Actions (if pending) -->
        {% if order.payment_status == 'pending' %}
        <div class="card mb-4">
            <div class="card-header bg-danger text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-check-circle me-2"></i>Payment Verification Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% if gateway_transaction %}
                    <div class="col-md-6 mb-3">
                        <div class="card border-primary">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-credit-card me-2 text-primary"></i>Verify Gateway Payment
                                </h6>
                                <p class="card-text small">
                                    Transaction ID: {{ gateway_transaction.gateway_transaction_id }}<br>
                                    Gateway: {{ gateway_transaction.payment_gateway.display_name }}
                                </p>
                                <form method="post" action="{% url 'orders:verify_gateway_payment' order.pk %}" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-check-circle me-1"></i>Verify Payment
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if has_manual_payment_submission %}
                    <div class="col-md-6 mb-3">
                        <div class="card border-success">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-university me-2 text-success"></i>Verify Manual Payment
                                </h6>
                                <p class="card-text small">
                                    Manual payment information has been submitted. Review the details and verify payment.
                                </p>
                                <form method="post" action="{% url 'orders:verify_manual_payment' order.pk %}" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-check-circle me-1"></i>Verify Payment
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.payment-proof-file {
    background: #f8f9fa;
    border-radius: 5px;
}

.transaction-details {
    background: #ffffff;
}

/* Prevent payment details sections from being hidden */
#transaction-details-section,
#manual-payment-section,
#payment-proof-files-section {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
}

/* Ensure alerts in payment sections don't fade out */
#transaction-details-section .alert,
#manual-payment-section .alert,
#payment-proof-files-section .alert {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Prevent payment details sections from being auto-hidden
    $(document).ready(function() {
        // Function to ensure section and alerts remain visible
        function ensureVisible(sectionId) {
            const section = $('#' + sectionId);
            if (section.length) {
                // Ensure section is visible
                section.css({
                    'display': 'block !important',
                    'visibility': 'visible !important',
                    'opacity': '1 !important'
                });
                
                // Ensure all alerts in section have no-auto-hide class and are visible
                section.find('.alert').each(function() {
                    $(this).addClass('no-auto-hide');
                    $(this).css({
                        'display': 'block !important',
                        'visibility': 'visible !important',
                        'opacity': '1 !important'
                    });
                });
            }
        }
        
        // Ensure all payment sections are visible on page load
        ensureVisible('transaction-details-section');
        ensureVisible('manual-payment-section');
        ensureVisible('payment-proof-files-section');
        
        // Monitor and restore visibility every 2 seconds (catches any auto-hide attempts)
        setInterval(function() {
            ensureVisible('transaction-details-section');
            ensureVisible('manual-payment-section');
            ensureVisible('payment-proof-files-section');
        }, 2000);
    });
</script>
{% endblock %}

